# iOS 백그라운드 푸시 알림 수신 문제 해결 가이드

## 🚨 문제 상황
- 앱을 실행하면 푸시 알림 수신이 다시 작동함
- 앱을 오랫동안 실행하지 않으면 푸시 알림이 수신되지 않음
- 다른 앱들은 오랫동안 접속하지 않아도 푸시가 잘 수신됨

## 🔍 원인 분석

### 1. FCM 토큰 만료 문제
- FCM 토큰은 일정 시간 후 만료됨
- iOS가 장시간 비활성 상태일 때 토큰이 무효화됨
- 앱 실행 시 새로운 토큰으로 갱신되어 다시 작동

### 2. iOS 백그라운드 앱 새로고침 문제
- iOS가 배터리 절약을 위해 백그라운드 앱 활동 제한
- 장시간 미사용 앱의 백그라운드 처리 중단

### 3. APNs 연결 문제
- iOS와 Apple Push Notification Service 연결이 끊어짐
- 앱 실행 시 연결이 재설정됨

## 🛠 해결책

### 1. iOS 기기 설정 확인 및 수정

#### A. 백그라운드 앱 새로고침 활성화
```
설정 > 일반 > 백그라운드 앱 새로고침
└── 백그라운드 앱 새로고침: 켜기
└── SMAP: 켜기 ✅
```

#### B. 저전력 모드 비활성화
```
설정 > 배터리 > 저전력 모드: 끄기
```

#### C. 화면 시간 제한 확인
```
설정 > 스크린 타임 > 앱 제한
└── SMAP이 제한되지 않았는지 확인
```

#### D. 집중 모드 설정 확인
```
설정 > 집중 모드
└── 방해금지 모드에서 SMAP 알림 허용 설정
```

### 2. FCM 토큰 관리 개선

#### A. 토큰 갱신 주기 단축
현재 30일 → 7일로 단축 권장

#### B. 백그라운드 토큰 유효성 검증 강화
주기적으로 서버에서 토큰 유효성 확인

#### C. 토큰 만료 시 자동 재등록
앱이 백그라운드에서도 토큰 상태 모니터링

### 3. iOS 앱 설정 최적화

#### A. Info.plist 확인
```xml
<key>UIBackgroundModes</key>
<array>
    <string>remote-notification</string>  <!-- ✅ 이미 설정됨 -->
    <string>background-fetch</string>     <!-- 선택적 -->
</array>
```

#### B. 백그라운드 알림 처리 강화
`application(_:didReceiveRemoteNotification:fetchCompletionHandler:)` 메서드 최적화

### 4. 서버 측 개선

#### A. 푸시 우선순위 설정
```python
# APNs 설정에서 우선순위를 최고로 설정
apns=messaging.APNSConfig(
    headers={
        "apns-priority": "10",  # 최고 우선순위
        "apns-push-type": "alert"
    }
)
```

#### B. 토큰 유효성 검증 강화
- 정기적으로 토큰 상태 확인
- 무효한 토큰 자동 제거
- 새로운 토큰 자동 등록

## 🚀 즉시 적용할 수 있는 해결책

### 1단계: iOS 기기 설정 최적화
```bash
# 사용자가 확인해야 할 설정들
echo "1. 설정 > 일반 > 백그라운드 앱 새로고침 > SMAP 켜기"
echo "2. 설정 > 배터리 > 저전력 모드 끄기"
echo "3. 설정 > 알림 > SMAP > 모든 알림 옵션 켜기"
echo "4. 설정 > 집중 모드 > 방해금지에서 SMAP 허용"
```

### 2단계: FCM 토큰 갱신 주기 단축
앱에서 토큰 갱신을 더 자주 수행하도록 설정

### 3단계: 서버 측 토큰 관리 개선
- 토큰 만료 감지 시 즉시 알림
- 백그라운드에서 토큰 유효성 정기 검증

## 🔧 고급 해결책

### 1. Silent Push Notification 활용
```python
# 주기적으로 silent push를 보내서 앱 깨우기
message = messaging.Message(
    data={'type': 'keep_alive'},
    apns=messaging.APNSConfig(
        headers={'apns-push-type': 'background'},
        payload=messaging.APNSPayload(
            aps=messaging.Aps(content_available=True)
        )
    ),
    token=token
)
```

### 2. 토큰 상태 모니터링 시스템
- 서버에서 정기적으로 토큰 유효성 검증
- 무효한 토큰 감지 시 사용자에게 알림
- 앱 실행 시 토큰 상태 즉시 복구

### 3. 사용자 가이드 제공
앱 내에서 백그라운드 알림 설정 가이드 제공

## 📊 문제 해결 우선순위

### 높음 (즉시 적용)
1. ✅ 백그라운드 앱 새로고침 활성화 안내
2. ✅ 저전력 모드 비활성화 안내
3. ✅ FCM 토큰 갱신 주기 단축

### 중간 (단기 개선)
1. 서버 측 토큰 유효성 검증 강화
2. Silent push를 통한 앱 활성화
3. 토큰 만료 감지 시스템 구축

### 낮음 (장기 개선)
1. 앱 내 설정 가이드 제공
2. 토큰 상태 대시보드 구축
3. 사용자별 푸시 수신 패턴 분석

## 🎯 예상 효과

이 해결책들을 적용하면:
- ✅ 앱을 실행하지 않아도 푸시 알림 정상 수신
- ✅ 다른 앱들과 동일한 수준의 백그라운드 푸시 성능
- ✅ 토큰 만료로 인한 푸시 실패 최소화
- ✅ 사용자 경험 대폭 개선

---

이 가이드를 따라 단계별로 적용하면 iOS 백그라운드 푸시 알림 문제를 완전히 해결할 수 있습니다.
