# iOS 백그라운드 푸시 장시간 유지 개선 가이드

## 🎯 문제 해결 목표
- **문제**: 포그라운드에서는 푸시 수신이 되지만, 백그라운드에서는 처음에만 수신되고 시간이 지나면 수신이 안됨
- **목표**: 백그라운드에서도 **오랫동안** 안정적으로 푸시 메시지를 받을 수 있도록 개선

## ✅ 적용된 개선사항

### 1. **Info.plist 백그라운드 모드 강화**
```xml
<key>UIBackgroundModes</key>
<array>
    <string>fetch</string>
    <string>remote-notification</string>
    <string>location</string>
    <string>background-processing</string>        <!-- 새로 추가 -->
    <string>background-app-refresh</string>       <!-- 새로 추가 -->
</array>
```

### 2. **APNs 설정 최적화 (90일 유효기간)**
```python
# firebase_service.py - 모든 APNs 설정에 적용
"apns-expiration": str(int(time.time()) + 7776000)  # 90일 유효 (기존 30일 → 90일)
"apns-priority": "10"  # 최고 우선순위 유지
```

### 3. **FCM 토큰 갱신 전략 강화**
```swift
// AppDelegate.swift
private let fcmTokenExpiryDays: Int = 3  // 3일로 단축 (기존 7일 → 3일)
private let maxTokenRetryAttempts: Int = 15  // 재시도 횟수 증가 (기존 10 → 15)
private let backgroundTokenRefreshInterval: TimeInterval = 1800  // 30분마다 (기존 1시간 → 30분)
private let backgroundKeepAliveInterval: TimeInterval = 600  // 10분마다 연결 유지
```

### 4. **백그라운드 연결 유지 메커니즘**
- **백그라운드 진입 시**: 자동으로 연결 유지 타이머 시작
- **30분마다**: 토큰 상태 확인 및 서버 업데이트
- **10분마다**: 백그라운드 연결 유지 신호 전송
- **1시간 이상 백그라운드**: 토큰 강제 갱신

### 5. **백그라운드 토큰 관리 로직**
```swift
private func performBackgroundKeepAlive() {
    // FCM 토큰 상태 확인
    updateFCMTokenToServerSilently(token: token, reason: "background_keepalive")
    
    // 장시간 백그라운드 시 토큰 강제 갱신
    if Date().timeIntervalSince(startTime) > 3600 {
        requestNewFCMToken(reason: "long_background_session")
    }
}
```

### 6. **조용한 백그라운드 업데이트**
```swift
private func updateFCMTokenToServerSilently(token: String, reason: String) {
    // 백그라운드에서 조용하게 토큰 상태 업데이트
    // 로그 최소화, 네트워크 오버헤드 최소화
}
```

## 🔧 핵심 개선 포인트

### **1. APNs 유효기간 연장**
- **30일 → 90일**: 더 오랫동안 푸시 메시지 전달 보장
- iOS 시스템에서 푸시 메시지를 더 오래 보관

### **2. 토큰 갱신 주기 단축**
- **7일 → 3일**: 더 자주 토큰을 갱신하여 연결 상태 유지
- 백그라운드에서도 토큰이 유효한 상태로 유지

### **3. 백그라운드 연결 유지**
- **10분마다**: 백그라운드에서 서버와 연결 상태 확인
- **30분마다**: 토큰 상태 갱신
- iOS가 백그라운드 앱을 "잠자기" 상태로 두지 않도록 방지

### **4. 장시간 백그라운드 대응**
- **1시간 이상**: 백그라운드에 있으면 토큰 강제 갱신
- iOS의 배터리 최적화로 인한 푸시 차단 방지

## 📱 사용자가 확인해야 할 iOS 설정

### **1. 앱별 설정**
```
iOS 설정 > SMAP > 백그라운드 앱 새로고침: ON
iOS 설정 > SMAP > 알림: 허용됨
```

### **2. 시스템 설정**
```
iOS 설정 > 일반 > 백그라운드 앱 새로고침: ON
iOS 설정 > 배터리 > 배터리 상태 및 충전 > 최적화된 배터리 충전: OFF (선택사항)
```

### **3. 집중 모드 설정**
```
iOS 설정 > 집중 모드 > 방해금지 모드에서 SMAP 알림 허용
```

## 🔄 백그라운드 푸시 지속성 개선 원리

### **iOS 백그라운드 푸시 제한 이유**
1. **배터리 최적화**: iOS가 자동으로 백그라운드 활동 제한
2. **메모리 관리**: 백그라운드 앱의 리소스 사용 제한
3. **사용 패턴**: 자주 사용하지 않는 앱의 푸시 우선순위 낮춤

### **개선된 대응 방법**
1. **적극적 토큰 갱신**: 토큰이 만료되기 전에 미리 갱신
2. **연결 유지**: 정기적으로 서버와 통신하여 "활성" 상태 유지
3. **최고 우선순위**: APNs priority 10으로 설정하여 시스템 제한 최소화
4. **긴 유효기간**: 90일 expiration으로 푸시 메시지 장기 보관

## ⚠️ 주의사항

### **1. 배터리 사용량**
- 백그라운드 연결 유지로 인한 배터리 사용량 약간 증가 가능
- 하지만 연결 유지 간격을 10분/30분으로 조정하여 최적화

### **2. 네트워크 사용량**
- 주기적인 토큰 갱신으로 인한 미미한 데이터 사용
- 조용한 업데이트로 오버헤드 최소화

### **3. iOS 시스템 제한**
- iOS 15+ 에서는 Focus Mode, Screen Time 등의 영향 받을 수 있음
- 사용자가 직접 앱별 설정을 확인해야 함

## 🧪 테스트 방법

### **1. 백그라운드 푸시 테스트**
```bash
# 1. 앱을 백그라운드로 보냄
# 2. 10분, 30분, 1시간, 3시간 후 각각 푸시 전송
# 3. 푸시 수신 여부 확인

# FCM 테스트 스크립트 사용
./fcm_test.sh
```

### **2. 장시간 테스트**
```
1. 앱을 백그라운드로 보냄
2. 3시간 후 푸시 메시지 전송
3. 6시간 후 푸시 메시지 전송
4. 12시간 후 푸시 메시지 전송
5. 각 시점에서 수신 여부 확인
```

### **3. 토큰 갱신 확인**
```
서버 로그에서 다음 로그 확인:
- [FCM BACKGROUND] 백그라운드 연결 유지 수행
- [FCM BACKGROUND] 백그라운드 토큰 갱신 수행
- [FCM BACKGROUND] 조용한 토큰 업데이트 성공
```

## 📊 예상 개선 결과

### **기존 (개선 전)**
- 포그라운드: ✅ 수신됨
- 백그라운드 30분: ✅ 수신됨  
- 백그라운드 1시간: ❌ 수신 안됨
- 백그라운드 3시간: ❌ 수신 안됨

### **개선 후 (예상)**
- 포그라운드: ✅ 수신됨
- 백그라운드 30분: ✅ 수신됨
- 백그라운드 1시간: ✅ 수신됨 (연결 유지)
- 백그라운드 3시간: ✅ 수신됨 (토큰 갱신)
- 백그라운드 12시간: ✅ 수신됨 (장기 유지)

## ✨ 결론

이번 개선으로 iOS 백그라운드 푸시 수신이 **몇 시간에서 하루 이상** 지속될 것으로 예상됩니다. 핵심은 **적극적인 토큰 관리**와 **백그라운드 연결 유지**입니다.

**사용자 체감**: "앱을 꺼둬도 푸시가 계속 잘 와요!" 💪
